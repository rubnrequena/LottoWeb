var CONFIG={INTERFAZ_MODO:"srq.taq.modoInterfaz",IMPRIMIR_TECLA:"srq.taq.imprimirTecla",IMPRIMIR_FORMATO:"srq.taq.formatoImpresion",IMPRIMIR_MODO:"srq.taq.modoImpresion",IMPRIMIR_LETRASxLINEA:"srq.taq.letrasLinea",SORTEOS_ORDEN:"srq.taq.ordenSorteos",SMS_KEY:"srq.taq.smskey",ELEMENTOS_HASH:"srq.taq.helementos",ELEMENTOS:"srq.taq.elementos"},init=function(){function e(e,t){T.setItem(e,t),M[e.split(".").pop()]=t,e==CONFIG.INTERFAZ_MODO&&$("#ventalink").attr("href",`#${t}`)}function t(){$("#gritter-item-"+w).remove(),q.connect()}function n(e,t){if(!G)return;0!=e.toString().indexOf("58")&&(e=`58${e}`);let n=`http://104.129.171.16:3000/enviar/${e}/?texto=${t}`;fetch(n).then(e=>e.json()).then(e=>{_.push(e),T.setItem("srqtaq.ws.enviados",JSON.stringify(_)),$("#ws-count").html(_.length)})}function a(e){return e.cierra>z.hora&&1==e.abierta}function r(e){return findBy("id",e,U)}function o(e){return findBy("sorteoID",e,K)}function i(e){var t,n=[];return e.forEach(function(e){t=findBy("sorteoID",e,K),n.push(t?"<p>"+t.descripcion+"</p>":"<p>"+padding(e,5)+"</p>")}),n.join("")}function l(e){var t,n,a,r=[];return e.forEach(function(e){t=findBy("id",e.n,U),n=findBy("sorteoID",e.s,K),a=e.hasOwnProperty("td")?"CUPO DISPONIBLE: "+e.td:"CUPO DISPONIBLE: "+e.tm,t&&n&&r.push("<p>"+n.descripcion+": "+t.d+"</p><p>"+a+"</p>")}),r.join("")}function s(e,n){function s(e){V.paginas.removeListener(Navegador.EXIT,s),$(document).off("keydown",N)}function c(e){e.which==parseInt(M.imprimirTecla)&&(e.preventDefault(e),setTimeout(function(){d()},100)),107==e.which&&(e.preventDefault(e),$("#srqag-nombre").focus())}function d(){var e=$("#srag-input").val();if(1==H&&(validateMail(e)?(m({mail:e}),me.modal("hide")):alert("CORREO INVALIDO")),2==H){var t=T.getItem(CONFIG.SMS_KEY);validatePhone(e)?(m({sms:e,key:t}),me.modal("hide")):alert("TELEFONO INVALIDO")}3==H&&(e=parseFloat(e).toString(),10==e.length&&(e="58"+e),validatePhone(e)?(m({wsc:e}),me.modal("hide")):alert("TELEFONO INVALIDO"))}function m(e){function t(e,n){if(X=!1,T.removeItem("lastTk"),ce.prop("disabled",X),n.hasOwnProperty("code"))if(5==n.code)notificacion("SORTEOS INV�LIDOS",i(n.sorteos));else if(6==n.code)notificacion("TOPE TAQUILLA EXEDIDO",l(n.elementos)),n.elementos.forEach(p),I();else if(7==n.code)notificacion("TOPE ANIMAL EXEDIDO",l(n.elementos)),n.elementos.forEach(p),I();else if(101==n.code)notificacion("VENTA CONFIRMADA","TICKET: #"+n.tk.ticketID+"<br/><small>CODIGO: "+n.tk.codigo+"</small>"),v();else if(4==n.code){let e=(new Date).getTime();notificacion("TICKET POSIBLEMENTE DUPLICADO",`<p><b>Venta no confirmada</b><br>. En el ultimo minuto se ha vendido un ticket con caracteristicas muy parecidas al actual.</p>\n                        <p>¿Confirma que desea realizar esta venta?</p>\n                        <button id="vnt-confirmar${e}" class="btn btn-success btn-block">Confirmar</button>`),$("#vnt-confirmar"+e).click(function(e){$(this).closest(".gritter-item-wrapper").remove(),n.venta.m.rw=!0,b.sendMessage("venta",n.venta,t)})}else notificacion("TICKET RECHAZADO");else notificacion("VENTA CONFIRMADA","TICKET: #"+n.tk.ticketID+"<br/><small>CODIGO: "+n.tk.codigo+"</small>"),"print"==n.format?0==H?h(n):4==H&&g(n):u(n),v()}if(0!=re.length){for(var n=0,a=0;a<re.length;a++)if(n+=re[a].monto,re[a].monto<J.vnt_min_num){var r=findBy("id",re[a].numero,U);return void notificacion("MONTO MINIMO NUMERO","No es posible procesar la venta, el monto asignado al #"+r.n+" "+r.d+" no cumple con el minimo requerido ("+formatNumber(J.vnt_min_num,2)+") por su banca")}if(n<J.vnt_min_tkt)notificacion("MONTO MINIMO TICKET","No es posible procesar la venta, el monto total del ticket ("+n+") no cumple con el minimo requerido por su banca ("+formatNumber(J.vnt_min_tkt,2)+")");else if(X)notificacion('<i class="fa fa-hand-stop-o"></i> ESPERE.. VENTA EN PROCESO.');else{if(!e){if(1==H||2==H)return void me.modal();if(-1==H)return void $("#printbtn").click()}if(2==H){var o=T.getItem(CONFIG.SMS_KEY);if(!o||""==o)return void notificacion("ERROR","<p>No es posible conectar con el servidor de mesajes, es necario asignar una llave valida.</p><p>Puede activarla en <a href='#preferencias'>Preferencias</a>, consulte con su administrador para obtener una llave.</p>")}0!=H||0!=P?(X=!0,ce.prop("disabled",X),T.setItem("lastTk",JSON.stringify(re)),b.sendMessage("venta",{m:e||{},v:re},t)):notificacion("ASISTENTE IMPRESION",jsrender($("#rd-print-alert")),"growl-danger")}}}function p(e){re.forEach(function(t){t.sorteoID==e.s&&t.numero==e.n&&(t.monto=e.tm||e.td,t.tpte=!0,0==t.monto&&re.splice(re.indexOf(t),1))})}function f(e){ee=e,$("#tk-last").html(e.ticket.ticketID)}function u(e){try{e.vt.length!=re.length&&alert("ALERTA: VERIFICAR TICKET, PUEDEN HABER CAMBIOS REALIZADOS POR EL SERVIDOR");for(var t=0;t<e.vt.length;t++)e.vt[t].sorteo=o(e.vt[t].sorteoID).descripcion;f({ticket:e.tk,ventas:e.vt})}catch(e){alert("SRQ HA DETECTADO UN ERROR, Por favor notificar a su administrador. ERROR: "+e.message),$("#vnt-ultimo").trigger("click")}}function g(e){for(var t=0;t<e.vt.length;t++)e.vt[t].sorteo=o(e.vt[t].sorteoID).descripcion;f({ticket:e.tk,ventas:e.vt}),x(e.vt,e.tk)}function h(e){try{e.vt.length!=re.length&&alert("ALERTA: VERIFICAR TICKET, PUEDEN HABER CAMBIOS REALIZADOS POR EL SERVIDOR");for(var t=0;t<e.vt.length;t++)e.vt[t].sorteo=o(e.vt[t].sorteoID).descripcion;f({ticket:e.tk,ventas:e.vt});var n=M.mimp||1;"atm"==n&&(n=e.vt.length>6?2:1),ue[n](e.vt,e.tk)}catch(e){alert("SRQ HA DETECTADO UN ERROR, Por favor notificar a su administrador. ERROR: "+e.message),$("#vnt-ultimo").trigger("click")}}function v(){re.length=0,oe.focus(),I()}function I(){re.sort(function(e,t){var n=e.sorteoID,a=t.sorteoID,r=e.numero,o=t.numero;return n==a?r-o:n-a}),$("#vnt-cesta").html(jsrender($("#rd-cesta-row"),re,de)),$(".rem-cesto").click(function(e){e.preventDefault(e);var t=parseInt($(e.currentTarget).attr("indice"));re.splice(t,1),I()});var e=0;re.forEach(function(t){e+=parseFloat(formatNumber(t.monto,2,".",""))}),se.html(e.format(2)),se.attr("datan",e.format(2,".","")),re.forEach(function(e){delete e.tpte})}function E(){0==M.ordenSorteos?K.sort(O):K.sort(A),ie.html(jsrender($("#rd-sorteo-option"),K.filter(a)))}function O(e,t){var n=e.sorteo,a=t.sorteo,r=e.cierra,o=t.cierra;return n==a?r-o:n-a}function A(e,t){var n=e.cierra,a=t.cierra;return n-a}function y(e,t){for(var n=0;n<re.length;n++)if(re[n].sorteoID==e&&re[n].numero==t)return n;return-1}function D(e,t){for(var n=0;n<U.length;n++)if(U[n].s==e&&U[n].n==t)return U[n].id;return-1}function N(e){if(e.altKey&&e.which>=96&&e.which<=105){e.preventDefault(e);var t=e.which-96;re.splice(t-1,1),I()}switch(e.which){case 13:e.target.id==ne||"vnt-numeros"==e.target.id?(e.preventDefault(e),oe.select2("close"),le.focus(),le.select()):e.target.id==ae&&(e.preventDefault(e),ie.select2("close"),oe.select2("open"),oe.focus());break;case parseInt(M.imprimirTecla):e.preventDefault(e),m(),ie.select2("close");break;case 109:e.preventDefault(e),re.length>0?(re.pop(),I()):(oe.select2("close"),ie.val(null).trigger("change"),ie.select2("open"));break;case 36:e.preventDefault(e),e.target.id==ne?(oe.select2("close"),le.focus(),le.select()):e.target.id==ae?(ie.select2("close"),oe.select2("open"),oe.focus()):(ie.select2("open"),ie.focus())}}function C(e,t,n){n=n||!1;var a=[{type:"linea",text:G.nombre,align:"center"},{type:"linea",text:t.hora,align:"center"},{type:"linea",text:"S:"+padding(t.ticketID,6)+" C:"+padding(t.codigo)+" N:"+e.length,align:"center"}];n?(a.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" N:"+e.length,align:"center"}),a.push({type:"linea",text:"COPIA - CADUCA 3 DIAS",align:"center"})):(a.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" C:"+padding(t.codigo)+" N:"+e.length,align:"center"}),a.push({type:"linea",text:"TICKET - CADUCA 3 DIAS",align:"center"})),e.sort(function(e,t){var n=e.sorteoID,a=t.sorteoID,r=e.numero,o=t.numero;return n==a?r-o:n-a});var o,i=e[0];a.push({type:"linea",text:i.sorteo,align:"center"});for(var l=0;l<e.length;l++)i.sorteoID!=e[l].sorteoID&&a.push({type:"linea",text:e[l].sorteo,align:"center"}),i=e[l],o=r(i.num||i.numero),a.push({type:"linea",text:["#"+o.n,o.d,formatNumber(i.monto,0)].join("\t "),align:"center"});a.push({type:"linea",text:"T:"+t.monto.format(2)+" AG"+Z,align:"left"}),a.push({type:"linea",text:" ",align:"left"}),q.sendMessage("print",{data:a,printer:1})}function x(e,t,n){function a(e){l.text(e,10,o),o+=i}n=n||!1;var o=10,i=8,l=new jsPDF,s=[{type:"linea",text:G.nombre.toUpperCase(),align:"center"},{type:"linea",text:t.hora,align:"center"}];n?(s.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" N:"+e.length,align:"center"}),s.push({type:"linea",text:"COPIA - CADUCA 3 DIAS",align:"center"})):(s.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" C:"+padding(t.codigo)+" N:"+e.length,align:"center"}),s.push({type:"linea",text:"TICKET - CADUCA 3 DIAS",align:"center"})),e.sort(function(e,t){var n=e.sorteoID,a=t.sorteoID,r=e.numero,o=t.numero;return n==a?r-o:n-a});var c,d,m=e[0],p=[],f=[],u={},g=0,h=0,v=1;f[g]=[{field:"l1",text:m.sorteo,width:"50"},{field:"l2",text:" ",width:"50"}],p[h]=[];for(var I=0;I<e.length;I++)m.sorteoID!=e[I].sorteoID&&(2==v&&p[h].push(u),s.push({type:"tabla",header:!1,columns:f[g++],data:p[h++]}),f[g]=[{field:"l1",text:e[I].sorteo,width:"50"},{field:"l2",text:" ",width:"50"}],p[h]=[],v=1,u={}),m=e[I],c=r(m.num||m.numero),2==v?(v=1,u.l2=("0"==c.n?"0  ":c.n)+" "+c.d.substr(0,3)+" "+formatNumber(m.monto,0),p[h].push(u),u={}):(v=2,u.l1=("0"==c.n?"0  ":c.n)+" "+c.d.substr(0,3)+" "+formatNumber(m.monto,0),u.l2=" ");2==v&&p[h].push(u),s.push({type:"tabla",header:!1,columns:f[g++],data:p[h++]}),s.push({type:"linea",text:"T:"+t.monto.format(2)+" AG"+Z,align:"left"});for(var E=0;E<s.length;E++)if(d=s[E],"linea"==d.type)a(d.text);else if("tabla"==d.type){var O=d.columns[0];a(O.text);for(var $,A=d.data,y=0;y<A.length;y++){$=A[y];var D="";$.hasOwnProperty("l1")&&(D+=$.l1+"\t"),$.hasOwnProperty("l2")&&(D+=$.l2),a(D)}}l.save("SRQ-"+t.ticketID)}function S(e,t,n){n=n||!1;var a=[{type:"linea",text:G.nombre,align:"center"},{type:"linea",text:t.hora,align:"center"}];n?(a.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" N:"+e.length,align:"center"}),a.push({type:"linea",text:"COPIA - CADUCA 3 DIAS",align:"center"})):(a.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" C:"+padding(t.codigo)+" N:"+e.length,align:"center"}),a.push({type:"linea",text:"TICKET - CADUCA 3 DIAS",align:"center"})),e.sort(function(e,t){var n=e.sorteoID,a=t.sorteoID,r=e.numero,o=t.numero;return n==a?r-o:n-a});var o,i=e[0],l=[],s=[],c={},d=0,m=0,p=1;s[d]=[{field:"l1",text:i.sorteo,width:"50"},{field:"l2",text:" ",width:"50"}],l[m]=[];for(var f=0;f<e.length;f++)i.sorteoID!=e[f].sorteoID&&(2==p&&l[m].push(c),a.push({type:"tabla",header:!1,columns:s[d++],data:l[m++]}),s[d]=[{field:"l1",text:e[f].sorteo,width:"50"},{field:"l2",text:" ",width:"50"}],l[m]=[],p=1,c={}),i=e[f],o=r(i.num||i.numero),2==p?(p=1,c.l2=("0"==o.n?"0  ":o.n)+" "+o.d.substr(0,3)+" "+formatNumber(i.monto,0),l[m].push(c),c={}):(p=2,c.l1=("0"==o.n?"0  ":o.n)+" "+o.d.substr(0,3)+" "+formatNumber(i.monto,0),c.l2=" ");2==p&&l[m].push(c),a.push({type:"tabla",header:!1,columns:s[d++],data:l[m++]}),a.push({type:"linea",text:"T:"+t.monto.format(2)+" AG"+Z,align:"left"}),a.push({type:"linea",text:" ",align:"left"}),q.sendMessage("print",{data:a,printer:1})}function R(e,t,n){n=n||!1;var a=[{type:"linea",text:G.nombre,align:"center"},{type:"linea",text:t.hora,align:"center"}];n?(a.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" N:"+e.length,align:"center"}),a.push({type:"linea",text:"COPIA - CADUCA 3 DIAS",align:"center"})):(a.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" C:"+padding(t.codigo)+" N:"+e.length,align:"center"}),a.push({type:"linea",text:"TICKET - CADUCA 3 DIAS",align:"center"})),e.sort(function(e,t){var n=e.sorteoID,a=t.sorteoID,r=e.numero,o=t.numero;return n==a?r-o:n-a});var o,i=33,l=e[0],s=[],c=[],d={},m=0,p=0,f=1;c[m]=[{field:"l1",text:l.sorteo,width:i},{field:"l2",text:" ",width:i},{field:"l3",text:" ",width:i}],s[p]=[];for(var u=0;u<e.length;u++)l.sorteoID!=e[u].sorteoID&&(f<4&&s[p].push(d),a.push({type:"tabla",header:!1,columns:c[m++],data:s[p++]}),c[m]=[{field:"l1",text:e[u].sorteo,width:i},{field:"l2",text:" ",width:i},{field:"l3",text:" ",width:i}],s[p]=[],f=1,d={}),l=e[u],o=r(l.num||l.numero),3==f?(f=1,d.l3=[o.n+"x"+formatNumber(l.monto,0)].join("\t "),s[p].push(d),d={}):2==f?(f++,d.l2=[o.n+"x"+formatNumber(l.monto,0)].join("\t ")):(f++,d.l1=[o.n+"x"+formatNumber(l.monto,0)].join("\t "),d.l2=" ",d.l3=" ");2!=f&&3!=f||s[p].push(d),a.push({type:"tabla",header:!1,columns:c[m++],data:s[p++]}),a.push({type:"linea",text:"T:"+t.monto.format(2)+" AG"+Z,align:"left"}),a.push({type:"linea",text:" ",align:"left"}),q.sendMessage("print",{data:a,printer:1})}function k(e,t,n){n=n||!1;var a=[{type:"linea",text:G.nombre,align:"center"},{type:"linea",text:t.hora,align:"center"}];n?(a.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" N:"+e.length,align:"center"}),a.push({type:"linea",text:"COPIA - CADUCA 3 DIAS",align:"center"})):(a.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" C:"+padding(t.codigo)+" N:"+e.length,align:"center"}),a.push({type:"linea",text:"TICKET - CADUCA 3 DIAS",align:"center"})),e.sort(function(e,t){var n=e.sorteoID,a=t.sorteoID,r=e.numero,o=t.numero;return n==a?r-o:n-a});for(var r=e[0],o=[],i=0;i<e.length;i++)r.sorteoID!=e[i].sorteoID&&(a.push({type:"linea",text:r.sorteo,align:"left"}),o.sort(_),j(o,a),o=[]),o.push(e[i]),r=e[i];a.push({type:"linea",text:r.sorteo,align:"left"}),o.sort(_),j(o,a),a.push({type:"linea",text:"T:"+t.monto.format(2)+" AG"+Z,align:"left"}),a.push({type:"linea",text:" ",align:"left"}),q.sendMessage("print",{data:a,printer:1})}function L(e,t,n){n=n||!1;var a=[{type:"linea",text:G.nombre,align:"center"},{type:"linea",text:t.hora,align:"center"}];n?a.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" N:"+e.length,align:"center"}):a.push({type:"linea",text:"S:"+padding(t.ticketID,6)+" C:"+padding(t.codigo)+" N:"+e.length,align:"center"}),a.push({type:"linea",text:"T:"+t.monto.format(2)+" AG"+Z,align:"left"}),a.push({type:"linea",text:" ",align:"left"}),q.sendMessage("print",{data:a,printer:1})}function j(e,t){function n(e,n){var r,o,i;a=F(e).join(",")+"x"+n.monto;for(var l=a.split(",");l.length>0;){var s=M.letrasLinea/3;if(a=l.splice(0,s).join(","),r=t[t.length-1].text.length,o=a.length,i=r+o,i>M.letrasLinea)if(o<=M.letrasLinea)t.push({type:"linea",text:a,align:"left"});else{var c=a.indexOf(",",22);-1==c&&(c=a.indexOf("x")),t.push({type:"linea",text:a.substr(0,c)+"-",align:"left"}),t.push({type:"linea",text:a.substr(c),align:"left"})}else t[t.length-1].text+=";"+a}}for(var a,o,i=e[0],l=[],s=0;s<e.length;s++)e[s].monto!=i.monto&&(n(l,i),l=[]),o=r(e[s].num||e[s].numero),l.push(o.n),i=e[s];n(l,i)}function _(e,t){var n=e.monto,a=t.monto,r=e.numero,o=t.numero;return n==a?r-o:n-a}function F(e){for(var t,n,a=[e[0]],r=1;r<e.length;r++)t=parseInt(e[r]),n=parseInt(e[r-1])+1,t!=n&&(a[a.length-1]!=e[r-1]&&(a[a.length-1]+="al"+e[r-1]),a.push(e[r]));return t==n&&a[a.length-1]!=e[r-1]&&(a[a.length-1]+="al"+e[r-1]),a}if(K){var H=M.formatoImpresion||0;if(H>0?(1==H&&$("#printbtn").html('<i class="fa fa-envelope"></i> ENVIAR'),2==H&&$("#printbtn").html('<i class="fa fa-mobile-phone"></i> ENVIAR'),4==H&&$("#printbtn").html('<i class="fa fa-file"></i> IMPRIMIR')):H<0&&($("#print-group").html(jsrender($("#print-select"))),$("#print-paper").click(function(e){e.preventDefault(e),H=0,$("#print-label").html('<i class="fa fa-print"></i> IMPRIMIR'),m()}),$("#print-mail").click(function(e){e.preventDefault(e),H=1,$("#print-label").html('<i class="fa fa-envelope"></i> ENVIAR'),me.modal()}),$("#print-pdf").click(function(e){e.preventDefault(e),H=4,$("#print-label").html('<i class="fa fa-file"></i> IMPRIMIR'),m({pdf:!0})}),$("#print-ws").click(function(e){e.preventDefault(e),H=3,$("#print-label").html('<i class="fa fa-whatsapp"></i> ENVIAR'),me.modal()})),localStorage.getItem("lastTk")){for(var Q=JSON.parse(localStorage.getItem("lastTk")),Y=0,W=0;W<Q.length;W++)Y+=Q[W].monto;localStorage.removeItem("lastTk"),notificacion("TICKET PENDIENTE","Posiblemente el ultimo ticket enviado por <b>"+Y.format(2)+"bs</b>, no se confirmo. </br>Por favor proceda a verificar.",null,!0)}$("body").hasClass("leftpanel-collapsed")||$(".menutoggle").trigger("click"),select2w($(".s2a"),{openOnEnter:!1}),V.paginas.addListener(Navegador.EXIT,s),$("#taq-nombre").html(G.nombre);var ee,te,ne,ae,re=[],oe=$("#vnt-numeros"),ie=$("#vnt-sorteos"),le=$("#vnt-monto"),se=$("#vnt-total"),ce=$("#vnt-btn"),de={pleno:function(e){var t=r(e);return"#"+t.n+" "+t.d},num:function(e){return r(e).n},sorteo:function(e){var t=findBy("sorteoID",e,K);return t.descripcion},formatn:formatNumber},me=$("#md-srqag"),pe=$("#srag-input"),fe=T.getItem("srqag.agenda")?JSON.parse(T.getItem("srqag.agenda")):[{n:"",v:""}];pe.html(jsrender($("#rd-srqag-item"),fe)),me.on("shown.bs.modal",function(e){$("#srag-input").select2("focus"),me.on("keydown",c),$(document).off("keydown",N)}),me.on("hide.bs.modal",function(e){me.off("keydown",c),$(document).on("keydown",N)}),$("#srqag-nuevo").submit(function(e){$(".srqag-ferror").addClass("hidden"),e.preventDefault(e);var t=formControls(this),n=findIndex("v",t.valor,fe);if(n>-1)$("#srqag-existeh").removeClass("hidden");else{var a=0;validateMail(t.valor)&&a++,parseInt(t.valor)&&a++,a>0?(fe.push({n:t.nombre,v:t.valor}),fe.sort(function(e,t){return e.n.localeCompare(t.n)}),pe.html(jsrender($("#rd-srqag-item"),fe)),formReset(this),pe.select2("focus"),T.setItem("srqag.agenda",JSON.stringify(fe)),$("#srqag-mailg").removeClass("has-error"),$("#srqag-to").addClass("hidden"),$("#srqag-existeh").addClass("hidden")):($("#srqag-mailg").addClass("has-error"),$("#srqag-to").removeClass("hidden"))}}),$("#srqag-rem").click(function(e){e.preventDefault(e);var t=pe.prop("selectedIndex");fe.splice(t,1),T.setItem("srqag.agenda",JSON.stringify(fe)),pe.html(jsrender($("#rd-srqag-item"),fe)),pe.select2("val","")}),$("#md-enviar-ok").click(d),$("#vnt-clr").click(v),ce.click(function(){m()}),$("#vnt-venta").submit(function(t){function n(e,t){if(e>-1){var n=y(t,e);n>-1?re[n].monto+=a.monto:re.push({numero:e,monto:a.monto,sorteoID:t})}}t.preventDefault(t);var a=formControls(this);if(""!=a.monto&&0!==a.monto){if("object"!=typeof a.numero){a.numero=a.numero.trim(),a.numero=a.numero.replace(/\*/g," "),a.numero=a.numero.split(" ");for(var r=a.numero.length-1;r>=0;r--)if(a.numero[r].indexOf("/")>-1){var o=a.numero[r].split("/");o.sort(function(e,t){return parseInt(e)-parseInt(t)}),a.numero.splice(r,1);for(var i=parseInt(o[0]),l=parseInt(o[1]),s=r,c=i;c<=l;c++)a.numero.splice(s++,0,padding(c,1))}}a.numero.forEach(function(e){var t=parseInt(e);t>0&&t<10&&(e="0"+t),a.sorteos.forEach(function(t){var a,r=findBy("sorteoID",t,K);if(0==r.zodiacal)if(a=D(r.sorteo,e),a>-1)n(a,t);else{var o=confirm("El numero "+e+" no se encontro para el sorteo "+r.descripcion+", puede probar restaurar esta data en preferencias y volver a intentar.");o&&V.url("preferencias|restaurar")}else{var i=ge.select2("val");if(i.length>0){var l;if(i.indexOf("TODOS")>-1)for(i=new Array(he.length),l=1;l<he.length;l++)i[l]=he[l].zID;for(l=0;l<i.length;l++)a=D(r.sorteo,e+i[l]),n(a,t)}else a=D(r.sorteo,e),n(a,t)}})}),I(),oe.val(null).trigger("change"),"venta"==e?oe.select2("focus"):$(oe).focus()}else le.focus()}),ie.on("change",function(e){var t=null;if(e.val&&e.val.length>0){t=findBy("sorteoID",e.val[0],K);for(var n=1;n<e.val.length;n++)if(t.sorteo!=findBy("sorteoID",e.val[n],K).sorteo){t=null;break}}if(t){var a=exploreBy("s",t.sorteo,U);oe.html(jsrender($("#rd-elemento-sorteo-option"),a))}else oe.html(jsrender($("#rd-elemento-option"),B));oe.select2("val",null).trigger("change");var r=$("#fg-zodiaco");r.addClass("hidden"),e.val.forEach(function(e){var t=findBy("sorteoID",e,K);1!=t.zodiacal||r.removeClass("hidden")})}),$("#vnt-dia").click(function(e){var t=new Date(z.hora);V.url("reporte/diario",[t.format()])}),$("#vnt-ultimo").click(function(){function e(e,t){if(t.ventas){var n;t.ventas.forEach(function(e){e.ventaID=padding(e.ventaID,6),n=o(e.sorteoID),n&&(e.srt=n.descripcion)}),f(t);var a=M.mimp||1;"atm"==a&&(a=ee.ventas.length>6?2:1),ue[a](ee.ventas,ee.ticket,!0)}}if(0==P)return w=notificacion("ASISTENTE IMPRESION",jsrender($("#rd-print-alert")),"growl-danger",!0),$(".print-rcn").off("click",t),void $(".print-rcn").on("click",t);b.sendMessage("venta-ultima",null,e)}),$("#ultventa-udp").click(function(e){e.preventDefault(e),$("#tk-last").html('<i class="fa fa-spinner fa-spin"></i>'),b.sendMessage("venta-ultima",null,ultimaVenta)}),$("#vnt-repetir").submit(function(e){e.preventDefault(e);var t,n,a=formControls(this);re.length=0;for(var r=0;r<a.numero.length;r++)t=findBy("sorteoID",a.sorteo[r],K),n=D(t.sorteo,a.numero[r]),n>-1?re.push({numero:n,monto:a.monto[r],sorteoID:a.sorteo[r]}):notificacion("NUMERO INVALIDO","El numero #"+a.numero[r]+" NO EXISTE EN SORTEO SELECCIONADO","growl-danger");I(),$("#md-repetir").modal("hide")}),$("#repetir").submit(function(e){e.preventDefault(e);var t=formControls(this),n=formLock(this);b.sendMessage("venta-repetir",t,function(e,t){formReset(n),te=t,t[0].h=1;for(var a=1;a<t.length;a++)t[a].sorteoID!=t[a-1].sorteoID&&(t[a].h=1);$("#vnt-repetir").html(jsrender($("#rd-repetir"),t,de)),$("#md-repetir").modal("show")})}),$("#md-repetir").on("shown.bs.modal",function(e){var t=K.filter(a);t=t.sort(O);var n=$(".s2sorteos");n.html(jsrender($("#rd-sorteo-option"),t)),select2w(n);var r=$(".rpt-plus"),o=$(".rpt-minus");t.forEach(function(e,t){$(".srt"+e.sorteoID).select2("val",e.sorteoID)}),r.click(function(){var e=parseInt($(this).attr("sorteo")),n=(te.length,$("select.srt"+e));n.each(function(e,n){var a=$(this),r=a.val(),o=findIndex("sorteoID",r,t);o<t.length-1&&a.prop("selectedIndex",o+1).change()})}),o.click(function(){var e=parseInt($(this).attr("sorteo")),n=(te.length,$("select.srt"+e));n.each(function(e,n){var a=$(this),r=a.val(),o=findIndex("sorteoID",r,t);o>0&&a.prop("selectedIndex",o-1).change()})})}),E(),oe.html(jsrender($("#rd-elemento-option"),B)),ie.select2("focus"),$(".select2-input").each(function(e){1==e&&(ne=this.id),0==e&&(ae=this.id)}),$(document).on("keydown",N);var ue=[C,S,R,k,L],ge=$("#vnt-zodiaco"),he=[{zID:"TODOS",desc:"TODOS"},{zID:"CP",desc:"CAPRICORNIO"},{zID:"AC",desc:"ACUARIO"},{zID:"PI",desc:"PISCIS"},{zID:"AR",desc:"ARIES"},{zID:"TA",desc:"TAURO"},{zID:"GE",desc:"GEMINIS"},{zID:"CN",desc:"CANCER"},{zID:"LE",desc:"LEO"},{zID:"VI",desc:"VIRGO"},{zID:"LI",desc:"LIBRA"},{zID:"ES",desc:"ESCORPION"},{zID:"SA",desc:"SAGITARIO"}];if(ge.html(jsrender($("#rd-zodiaco-option"),he)),n&&n.length>0){var ve=n[1]||10,Ie=0,Ee=0,Oe=K.filter(a),$e=(new Date).getTime();function Ae(){for(var e=getRandomInt(1,Oe.length),t=[],n=0;n<e;n++){var a=Oe[parseInt(Math.random()*Oe.length)],r=exploreBy("s",a.sorteo,U),o=parseInt(Math.random()*r.length),i={monto:parseFloat(getRandomArbitrary(.1,10).toFixed(2)),numero:r[o].id,sorteoID:a.sorteoID};Ie+=i.monto,t.push(i)}(new Date).getTime();b.sendMessage("venta",{v:t},function(e,t){$("#bot").html(++Ee+" de "+ve+" ventas confirmadas, con "+Ie.format(2)+" bs"),Ee<ve?Ae():$("#bot").append(",en "+((new Date).getTime()-$e)+" ms")})}Ae()}}else V.nav("101")}function c(e,t){$("#sorteo-buscar").submit(function(e){e.preventDefault(e);var t=formControls(this),n=formLock(this);b.sendMessage("sorteos",t,function(e,t){formLock(n,!1),$("#sorteos-body").html(jsrender($("#rd-sorteo-row"),t||[]))})})}function d(e,t){var n,a=0,r=0,o=0,i=$("#reporte-fecha"),l={sorteo:function(e){var t=findBy("sorteoID",e,K);return t?t.descripcion:padding(e,6)},format:formatNumber};if($("#reporte").submit(function(e){e.preventDefault(e);var t=formControls(this),i=formLock(this);b.sendMessage("reporte-diario",t,function(e,t){formLock(i,!1),n=t||[],a=0,r=0,o=0,n.forEach(function(e){a+=e.jugado,r+=e.pago,o+=e.premio}),$("#mnt-jugado").html(a.format(2)),$("#mnt-premios").html(o.format(2)),$("#mnt-pagos").html(r.format(2)),$("#mnt-balance").html((a-o).format(2)),$("#mnt-pendiente").html((o-r).format(2)),$("#mnt-ppagos").html((r/o*100).format(2)),$("#reporte-body").html(jsrender($("#rd-reporte-diario"),t,l))})}),$("#print-reporte").click(function(){var e=new Date,t=[{type:"linea",text:G.nombre,align:"center"},{type:"linea",text:e.format("yy-mm-dd")+" "+e.format("TZ:240 h:MM:s TT"),align:"center"},{type:"linea",text:"REPORTE DIARIO",align:"center"}];t.push({type:"linea",text:"JUGADO: "+a.format(2),align:"left"}),t.push({type:"linea",text:"PREMIOS: "+o.format(2),align:"left"}),t.push({type:"linea",text:"PAGOS: "+r.format(2),align:"left"}),t.push({type:"linea",text:"PENDIENTE: "+(o-r).format(2),align:"left"}),t.push({type:"linea",text:"BALANCE: "+(a-o).format(2),align:"left"}),t.push({type:"linea",text:" ",align:"left"}),q.sendMessage("print",{data:t,printer:1})}),t&&1==t.length){var s=t[0].split("-");i.datepicker("setDate",new Date(s[0],parseInt(s[1])-1,s[2])),$("#reporte").trigger("submit")}}function m(e,t){function n(){r=0,o=0,i=0,l=0,s=0,$(".clr-val").html("--"),$("#reporte-body").html(""),a.forEach(function(e){e.balance=e.jugada-(0==c.val()?e.pago:e.premio),s+=e.balance,r+=e.jugada,o+=e.pago,i+=e.premio,l+=e.comision}),$("#mnt-jugado").html(r.format(2)),$("#mnt-premios").html(i.format(2)),$("#mnt-pagos").html(o.format(2)),$("#mnt-balance").html((s-l).format(2)),$("#comision").html(l.format(2)),$("#mnt-neto").html(s.format(2)),0!=a.length&&(0==c.val()?$("#reporte-body").html(jsrender($("#rd-reporte-diario"),a,W)):$("#reporte-body").html(jsrender($("#rd-reporte-diario2"),a,W)))}var a,r,o,i,l,s,c=$("#prm-select");$("#reporte").submit(function(e){e.preventDefault(e);var t=formLock(this),r=formControls(this);b.sendMessage("reporte-general",r,function(e,r){formLock(t,!1),a=r||[],n()})}),c.change(n),$("#print-reporte").click(function(){var e=new Date;a.forEach(function(e){e.desc=e.descripcion.substr(-8)});var t=[{type:"linea",text:G.nombre,align:"center"},{type:"linea",text:e.format("yy-mm-dd")+" "+e.format("TZ:240 h:MM:s TT"),align:"center"},{type:"linea",text:"REPORTE GENERAL",align:"center"}];t.push({type:"linea",text:a[0].descripcion+" - "+a[a.length-1].descripcion,align:"center"}),0==c.val()?(t.push({type:"linea",text:"**PREMIOS PAGADOS**",align:"center"}),i=o,t.push({type:"tabla",data:a,header:!0,columns:[{text:"FECHA",field:"desc",width:25},{text:"JUGADO",field:"jugada",width:25},{text:"PREMIO",field:"pago",width:25},{text:"BALANCE",field:"balance",width:25}]})):t.push({type:"tabla",data:a,header:!0,columns:[{text:"FECHA",field:"desc",width:25},{text:"JUGADO",field:"jugada",width:25},{text:"PREMIO",field:"premio",width:25},{text:"BALANCE",field:"balance",width:25}]}),t.push({type:"linea",text:" ",align:"left"}),t.push({type:"linea",text:"JUGADO: "+r.format(2),align:"left"}),t.push({type:"linea",text:"PREMIOS: "+i.format(2),align:"left"}),t.push({type:"linea",text:"COMISION: "+l.format(2),align:"left"}),t.push({type:"linea",text:"BALANCE: "+(r-i-l).format(2),align:"left"}),t.push({type:"linea",text:" ",align:"left"}),q.sendMessage("print",{data:t,printer:1})})}function p(e,t){padding,dateFormat;var n=$("#reporte-fecha");n.change(function(e){b.sendMessage("sorteos",{nombres:e.target.value},function(e,t){$("#sorteos").html(jsrender($("#rd-sorteo-option"),t))})}),n.trigger("change"),$("#reporte").submit(function(e){e.preventDefault(e);var t=formControls(this),n=formLock(this);$("#reporte-vnt").html(""),$("#reporte-elm").html(""),b.sendMessage("reporte-sorteo",t,function(e,t){formLock(n,!1),t.vnt=t.vnt||[];var a=0,r=0,o=0,i=0,l=0;t.vnt.forEach(function(e){0==e.anulado&&(a+=e.monto,r+=e.premio,o+=e.pago>0?e.premio:0,e.premio>0&&i++,e.pago>0&&l++,1==e.anulado&&0)}),$("#mnt-jugado").html(a.format(2)),$("#mnt-premios").html(r.format(2)),$("#mnt-pagos").html(o.format(2)),$("#tk-total").html(t.vnt.length),$("#tk-premios").html(i),$("#tk-pagos").html(l),$("#reporte-vnt").html(jsrender($("#rd-reporte-vnt"),t.vnt)),$(".fticket").click(function(){var e=$("#md-ticket"),t=$(this).data("id");e.on("shown.bs.modal",function(n){e.off("shown.bs.modal",arguments.callee);var a=$("#md-pagar-ticket");a.val(parseInt(t)),a.focus()}),e.modal("show")})})}),t&&t.length}function f(e,t){function n(){f.html(""),u.html(""),$(".es-reset").html("--"),h=1,v=0}function a(e,t){t.data&&(i.push(t.data),g=g.concat(t.data),o(t.data),u.append('<button class="btn btn-default nav-btn">'+ ++h+"</button>")),t.last&&(b.removeListener("reporte-ventas",a),$(".nav-btn").click(function(){var e=$(this);v=parseInt(e.html())-1,e.hasClass("btn-default")&&($(".nav-btn").switchClass("btn-primary","btn-default"),e.switchClass("btn-default","btn-primary"),r(i[v]))}))}function r(e){f.html(jsrender($("#rd-reporte-diario"),e)),$(".fticket").click(function(){var e=$("#md-ticket"),t=$(this).data("id");e.on("shown.bs.modal",function(n){e.off("shown.bs.modal",arguments.callee);var a=$("#md-pagar-ticket");a.val(parseInt(t)),a.focus()}),e.modal("show")})}function o(e){if(e){e.forEach(function(e){0==e.a?(l+=e.m,s+=e.pg,c+=e.pr):(d++,m+=e.m)});var t=l*G.comision*.01;$("#mnt-jugado").html(l.format(2)),$("#mnt-premios").html(c.format(2)),$("#mnt-pagos").html(s.format(2)),$("#mnt-balance").html((l-c-t).format(2)),$("#mnt-comision").html(t.format(2)),$("#mnt-pendiente").html((c-s).format(2)),$("#mnt-ppagos").html((s/c*100).format(2)),$("#mnt-tanulados").html(d.format(2)),$("#mnt-anulados").html(m.format(2))}}var i,l=0,s=0,c=0,d=0,m=0,p=$("#reporte-fecha"),f=$("#reporte-body"),u=$("#nav-table"),g=[];$("#rpt-vpremio").click(function(){var e=g.filter(function(e){return e.pr>0});r(e),$(".nav-btn").addClass("disabled")}),$("#rpt-vjugado").click(function(){r(i[v]),$(".nav-btn").removeClass("disabled")}),$("#rpt-vanulado").click(function(){var e=g.filter(function(e){return e.a>0});r(e),$(".nav-btn").addClass("disabled")}),$("#rpt-vpend").click(function(){var e=g.filter(function(e){return e.pg<e.pr});r(e),$(".nav-btn").addClass("disabled")}),$("#rpt-vpagos").click(function(){var e=g.filter(function(e){return e.pg>0});r(e),$(".nav-btn").addClass("disabled")}),$("#reporte").submit(function(e){e.preventDefault(e),g.length=0,l=0,s=0,c=0,d=0,m=0;var t=formControls(this),p=formLock(this);n(),b.sendMessage("reporte-ventas",t,function(e,t){t.last||b.addListener("reporte-ventas",a),g=t.data||[],formLock(p,!1),t.data&&(i=[t.data],o(t.data),r(t.data),u.html('<button class="btn btn-primary nav-btn">1</button>'))})});var h=1,v=0;if($("#print-reporte").click(function(){var e=new Date,t=[{type:"linea",text:G.nombre,align:"center"},{type:"linea",text:e.format("yy-mm-dd")+" "+e.format("TZ:240 h:MM:s TT"),align:"center"},{type:"linea",text:"REPORTE TICKETS",align:"center"}];t.push({type:"linea",text:"JUGADO: "+l.format(2),align:"left"}),t.push({type:"linea",text:"PREMIOS: "+c.format(2),align:"left"}),t.push({type:"linea",text:"PAGOS: "+s.format(2),align:"left"}),t.push({type:"linea",text:"PENDIENTE: "+(c-s).format(2),align:"left"}),t.push({type:"linea",text:"BALANCE: "+(l-s).format(2),align:"left"}),t.push({type:"linea",text:" ",align:"left"}),q.sendMessage("print",{data:t,printer:1})}),t&&1==t.length){var I=t[0].split("-");p.datepicker("setDate",new Date(I[0],parseInt(I[1])-1,I[2])),$("#reporte").trigger("submit")}}function u(t,n){var a=$("#md-impresion"),r=$("#ft-impresion"),o=$("#lt-linea"),i=$("#md-orden"),l=$("#md-intefaz");l.change(function(t){var n=l.val();e(CONFIG.INTERFAZ_MODO,n)}),l.select2("val",M.modoInterfaz||"ventamax"),l.val(M.modoInterfaz||"ventamax"),a.change(function(t){e(CONFIG.IMPRIMIR_MODO,a.val())});var s=M.mimp;a.select2("val",s||1),a.val(s||1),r.change(function(t){e(CONFIG.IMPRIMIR_FORMATO,r.val())});var c=M.formatoImpresion;r.select2("val",c||0),r.val(c||0),o.val(M.letrasLinea),$("#btnletras").click(function(){e(CONFIG.IMPRIMIR_LETRASxLINEA,o.val()),notificacion("Letras Linea","Cambio exitoso")}),i.select2("val",M.ordenSorteos||0),i.val(M.ordenSorteos),i.change(function(t){e(CONFIG.SORTEOS_ORDEN,i.val())
}),$("#prf-ticketPrueba").click(function(e){var t=[[{type:"linea",text:"AG. DEMO",align:"center"},{type:"linea",text:"04/06/17 06:12:14 AM",align:"center"},{type:"linea",text:"9999999-1234",align:"center"},{type:"linea",text:"TICKET PRUEBA",align:"center"},{type:"linea",text:"RULETA ACTIVA 10AM",align:"center"},{type:"linea",text:"#0\t DELFIN\t 99999",align:"center"},{type:"linea",text:"#01\t CARNERO\t 99999",align:"center"},{type:"linea",text:"#02\t TORO\t 99999",align:"center"},{type:"linea",text:"#03\t CIEMPIES\t 99999",align:"center"},{type:"linea",text:"#04\t ALACRAN\t 99999",align:"center"},{type:"linea",text:"#05\t LEON\t 99999",align:"center"},{type:"linea",text:"#06\t RANA\t 99999",align:"center"},{type:"linea",text:"#07\t PERICO\t 99999",align:"center"},{type:"linea",text:"#08\t RATON\t 99999",align:"center"},{type:"linea",text:"#09\t AGUILA\t 99999",align:"center"},{type:"linea",text:"TOTAL: 999990",align:"center"},{type:"linea",text:"CADUCA EN 3 DIAS",align:"center"},{type:"linea",text:"c8dda1ff1abe1e7ddd1042a2213b3da0",align:"center"},{type:"linea",text:" ",align:"left"}],[{type:"linea",text:"AG. DEMO",align:"center"},{type:"linea",text:"04/06/17 06:12:14 AM",align:"center"},{type:"linea",text:"9999999-1234",align:"center"},{type:"linea",text:"TICKET PRUEBA",align:"center"},{type:"tabla",header:!1,columns:[{field:"l1",text:"RULETA ACTIVA 10AM",width:"50"},{field:"l2",text:" ",width:"50"}],data:[{l1:"0\tDELF\t99999",l2:"01\tCARN\t99999"},{l1:"02\tTORO\t99999",l2:"03\tCIEM\t99999"},{l1:"04\tALAC\t99999",l2:"05\tLEON\t99999"},{l1:"06\tRANA\t99999",l2:"07\tPERI\t99999"},{l1:"08\tRATO\t99999",l2:"09\tAGUI\t99999"}]},{type:"linea",text:"TOTAL: 999990",align:"center"},{type:"linea",text:"CADUCA EN 3 DIAS",align:"center"},{type:"linea",text:"c8dda1ff1abe1e7ddd1042a2213b3da0",align:"center"},{type:"linea",text:" ",align:"left"}],[{type:"linea",text:"AG. DEMO",align:"center"},{type:"linea",text:"04/06/17 06:12:14 AM",align:"center"},{type:"linea",text:"9999999-1234",align:"center"},{type:"linea",text:"TICKET PRUEBA",align:"center"},{type:"tabla",header:!1,columns:[{field:"l1",text:"RULETA ACTIVA 10AM",width:33},{field:"l2",text:" ",width:33},{field:"l3",text:" ",width:33}],data:[{l1:"0x99999",l2:"01x99999",l3:"02x99999"},{l1:"03x99999",l2:"04x99999",l3:"05x99999"},{l1:"06x99999",l2:"07x99999",l3:"08x99999"},{l1:"09x99999",l2:" ",l3:" "}]},{type:"linea",text:"TOTAL: 999990",align:"center"},{type:"linea",text:"CADUCA EN 3 DIAS",align:"center"},{type:"linea",text:"c8dda1ff1abe1e7ddd1042a2213b3da0",align:"center"},{type:"linea",text:" ",align:"left"}]],n=M.mimp||0;"atm"==n&&(n=2),q.sendMessage("print",{data:t[n],printer:1})});var d=$("#btnimprimir"),m=$("#scimprimir");m.val(getKeyName(M.imprimirTecla)),d.click(function(t){function n(t){$(document).off("keydown",n),t.metaKey||t.preventDefault();var a=getKeyName(t.keyCode);a&&(m.val(a),e(CONFIG.IMPRIMIR_TECLA,t.keyCode)),d.html("Editar")}$(document).on("keydown",n),d.html("Presione una tecla...")}),$("#prf-rest-numeros").click(function(){var e=confirm("Esta accion reinicara el listado de numeros almacenados y reiniciara su sesion");e&&(T.removeItem(CONFIG.ELEMENTOS),T.removeItem(CONFIG.ELEMENTOS_HASH),location.reload())}),$("#sms-key").submit(function(e){e.preventDefault(e);var t=formControls(this);T.setItem(CONFIG.SMS_KEY,t.smskey),notificacion("CAMBIOS REALIZADOS")}),$("#smskey").val(T.getItem(CONFIG.SMS_KEY)),n&&n.length>0&&$("html, body").animate({scrollTop:$("#"+n[0]).offset().top},500)}function g(e,t){var n=["#ayuda-venta","#ayuda-pago","#ayuda-anular"];if(t.length>0){var a=t[0];$("html, body").animate({scrollTop:$(n[a]).offset().top},1e3)}}function h(e){L=e||L,console.log("conectando a ",L),b=new Net("ws://"+L,!1),b.addListener(NetEvent.SOCKET_OPEN,A),b.addListener(NetEvent.LOGIN,C),b.addListener("duplicado",E),b.addListener("close-mant",O),b.addListener(NetEvent.SOCKET_CLOSE,N),b.addListener(NetEvent.SOCKET_ERROR,D),b.addListener("init",v),b.addListener("fingerprint",I),b.addListener(NetEvent.DATA_CHANGE,function(){$("#main-bin").text(Net.parseBytes(b.bytesIn)),$("#main-bout").text(Net.parseBytes(b.bytesOut))}),b.addListener("venta-anular-banca",function(e,t){notificacion("TICKET ANULADO POR BANCA","TICKET #"+t,"growl-success",!0)}),b.addListener("sorteos-update",function(e,t){K=t.sorteos}),b.addListener("estatus-change",function(e,t){var n=t.cierra?"CIERRA":"ABRE",a=findBy("sorteoID",t.sorteoID,K);a&&notificacion("SISTEMA","SORTEO <strong>"+a.descripcion+"</strong> "+n)}),b.addListener("srt-premio",function(e,t){var n=findBy("sorteoID",t.sorteoID,K),a=findBy("id",t.ganador,U);n&&notificacion("PREMIOS RECIBIDOS","SORTEO: "+n.descripcion+"</br>#"+a.n+" "+a.d,null,!1)}),b.addListener("metas",function(e,t){J=t,J.hasOwnProperty("msg_init")&&J.msg_init.length>0&&notificacion("MENSAJE BANCA",J.msg_init,"",!0),J.hasOwnProperty("msg_srv")&&J.msg_srv.length>0&&notificacion("MENSAJE SERVIDOR",J.msg_srv,"",!0)}),b.addListener("sms-result",function(e,t){$.ajax({url:"http://srq-hermes.herokuapp.com/api/log",data:{usuario:G.usuario,numero:t.num,contenido:t.code},dataType:"json"}).done(e=>{console.log(e)}),200==t.code&&notificacion("MENSAJE ENVIADO","<p>Numero: "+t.num+"</p>"),1e3==t.code&&notificacion("MENSAJE NO ENVIADO","<p>LLAVE INVALIDA</p>"),1001==t.code&&notificacion("MENSAJE NO ENVIADO","<p>LLAVE INACTIVA</p>"),1002==t.code&&notificacion("MENSAJE NO ENVIADO","<p>SALDO INSUFICIENTE</p>")}),b.connect()}function v(e,t){z.hora=t.t,null==T.fpud62737hdh2&&(T.fpud62737hdh2=H.getFingerprint()),Z=T.fpud62737hdh2,Q=md5(Z.toString()+t.t),Y>0&&clearInterval(Y),Y=setInterval(function(){z.hora+=1e3},1e3);var n=T.getItem("loto_taqlogin");n&&y(JSON.parse(n))}function I(e,t){b.removeListener("fingerprint",I),b.sendMessage(e,Z)}function E(e){V.nav("506",null,null,"body"),b.removeListener(NetEvent.SOCKET_CLOSE,N),b.close()}function O(e){V.nav("601",null,null,"body"),b.removeListener(NetEvent.SOCKET_CLOSE,N),b.close()}function A(e){$("#conectando").fadeOut()}function y(e,t){e.fp=Q,b.sendMessage("login",e,t)}function D(e){b.removeListener(NetEvent.SOCKET_CLOSE,N),console.log("ERROR AL CONECTAR")}function N(e){console.log("NO CONECTAAAAA"),$("#conectando").fadeIn(),X=!1,setTimeout(h,3e3)}function C(e,t){function n(e,t){var r=T.getItem(CONFIG.ELEMENTOS_HASH);if(r==e)try{a(),t()}catch(e){n("refres",t)}else{notificacion("Espere...",'<p id="ntf-cargaelem"><i class="fa fa-spinner fa-spin"></i> Recibiendo listado animales</p>');var o=[];b.addListener("elementos-init",function(e,n){n.hasOwnProperty("hash")?(T.setItem(CONFIG.ELEMENTOS_HASH,n.hash),T.setItem(CONFIG.ELEMENTOS,JSON.stringify(o)),$("#ntf-cargaelem").html('<i class="fa fa-check"></i> Lista de animales recibido'),b.removeListeners(e),a(),t()):o=o.concat(n)}),b.sendMessage("elementos-init",null)}}function a(){U=JSON.parse(T.getItem(CONFIG.ELEMENTOS));if(!U||0==U.length){var e=confirm("No hay registrados elementos para los sorteos registrados, desea cargarlos nuevamente?");e&&n("",function(){V.navUrl()})}}t.hasOwnProperty("code")?5==t.code?(V.nav("507",null,null,"body"),T.removeItem("loto_taqlogin"),b.removeListener(NetEvent.SOCKET_CLOSE,N),b.close()):505==t.code&&notificacion("USUARIO SUSPENDIDO","Comuniquese con su administrador o banquero","growl-danger"):(G=t.taq,$(".username").html(G.nombre),K=t.sorteos,z.hora=t.time,n(t.elementos,function(){V.navUrl()}))}var b,T=localStorage,x=location.search,S=/ip=(?<ip>[\w.:]+)/,R=S.exec(x),k=R?R.groups.ip:null,L=k||$.cookie("taquilla")||location.hostname+":4022",M={mimp:T.getItem(CONFIG.IMPRIMIR_MODO)||1,imprimirTecla:T.getItem(CONFIG.IMPRIMIR_TECLA)||107,formatoImpresion:T.getItem(CONFIG.IMPRIMIR_FORMATO)||0,letrasLinea:T.getItem(CONFIG.IMPRIMIR_LETRASxLINEA)||25,ordenSorteos:T.getItem(CONFIG.SORTEOS_ORDEN)||0,modoInterfaz:T.getItem(CONFIG.INTERFAZ_MODO||"ventamax")};$("#ventalink").attr("href",`#${M.modoInterfaz||"ventamax"}`);var w,P=!1,q=new Net("ws://127.0.0.1:9999",!1);q.addListener(NetEvent.SOCKET_OPEN,function(e){P=!0,notificacion("ASISTENTE IMPRESION","CONEXION EXITOSA","growl-success")}),q.addListener(NetEvent.SOCKET_CLOSE,function(e){P=!!H.isMobile(),0==M.formatoImpresion&&0==H.isMobile()&&(w=notificacion("ASISTENTE IMPRESION",jsrender($("#rd-print-alert")),"growl-danger",!0),$(".print-rcn").off("click",t),$(".print-rcn").on("click",t))}),q.connect();let j=$("#ws-send"),_=JSON.parse(T.getItem("srqtaq.ws.enviados"))||[],F=JSON.parse(T.getItem("srqtaq.ws.banned"))||[];$("#ws-count").html(_.length);for(let e=0;e<F.length;e++){const t=F[e],n=(new Date).getTime();n>t.hasta&&(F.splice(e,1),T.setItem("srqtaq.ws.banned",JSON.stringify(F)))}j.submit(function(e){e.preventDefault(e);let t=formControls(this);for(let e=0;e<F.length;e++){const n=F[e];if(n.numero==t.numero)return $("#wsban-alert").removeClass("hidden"),void setTimeout(()=>$("#wsban-alert").addClass("hidden"),5e3)}n(t.numero,t.mensaje),$("#wsban-alert").addClass("hidden"),j[0].reset()}),setInterval(()=>{for(let e=_.length-1;e>=0;e--){const t=_[e];fetch(`http://104.129.171.16:3000/msg/${t._id}`).then(e=>e.json()).then(t=>{t.hasOwnProperty("error")?(_.splice(e,1),notificacion("Whatsapp",`<p>Mensaje NO enviado<br>Razon: Numero Incorrecto o No Existe</p><p>Numero: ${t.numero}</p>`,"growl-danger"),T.setItem("srqtaq.ws.enviados",JSON.stringify(_)),F.push({numero:t.numero,hasta:(new Date).getTime()+6e4}),T.setItem("srqtaq.ws.banned",JSON.stringify(F))):t.hasOwnProperty("enviado")&&(_.splice(e,1),notificacion("Whatsapp",`<p>Mensaje enviado</p><p>Numero: ${t.numero}</p>`,"growl-success"),T.setItem("srqtaq.ws.enviados",JSON.stringify(_))),$("#ws-count").html(_.length)})}},5e3);var G,U,K,B,V=new Navegador;V.folder="paginas",V.viewport=".contentpanel",V.validate=function(e,t){return"507"==e?e:G?e:"login"};var z={},J={},H=new ClientJS;V.paginas.addListener(Navegador.ENTER,function(e,t){var n=jQuery(".mainpanel"),a=jQuery(document).height(),r=n.height();a>r&&n.height(a),select2w($(".s2"),{hideSelectionFromResult:function(e){return!0},placeholder:"Seleccione...",language:"es"}),$(".date").datepicker({dateFormat:"yy-mm-dd"}),$(".now").datepicker("setDate",new Date)}),V.paginas.addListener(Navegador.COMPLETE,function(e,t){var n=jQuery(".panel-heading");n.attr("title","Click para expandir y/o contraer panel"),n.click(function(){var e=jQuery(this).find(".minimize"),t=e.closest(".panel");return e.hasClass("maximize")?(t.find(".panel-body, .panel-footer").slideDown(200),e.removeClass("maximize"),e.html("&minus;")):(t.find(".panel-body, .panel-footer").slideUp(200),e.addClass("maximize"),e.html("&plus;")),!1}),jQuery(".panel .panel-close").click(function(){return jQuery(this).closest(".panel").fadeOut(200),!1})}),V.paginas.addListener("login",function(e,t){$("#login-form").submit(function(e){e.preventDefault(e);var t=formControls(this),n=formLock(this);y(t,function(e,a){if(formLock(n,!1),a.hasOwnProperty("code"))2==a.code&&notificacion("CLAVE INVALIDA");else{var r=$("#recordar").is(":checked");r?T.setItem("loto_taqlogin",JSON.stringify(t)):T.removeItem("loto_taqlogin")}})})}),V.paginas.addListener("inicio",function(e,t){function n(){var e=V.current().page;"inicio"==e?($("#servidor-tiempo").html(dateFormat(z.hora,"TZ:240 dd/mm/yy hh:MM TT")),K.forEach(function(e){e.abierta&&e.cierra>z.hora?$("#srt-resta-"+e.sorteoID).html(msToString(e.cierra-z.hora)):$("#srt-resta-"+e.sorteoID).html("<label class='label label-danger'>CERRADO</label>")})):clearInterval(a)}var a,r={gano:function(e){var t=findBy("id",e,U);return t?0==e?"":"#"+t.n+" "+t.d:"NA"},formatDate:dateFormat};$("#pagina-tiulo").html('<i class="fa fa-home"></i> Bienvenido, '+G.nombre),K&&(a=setInterval(n,6e4),$("#sorteos-body").html(jsrender($("#rd-inicio-sorteos-row"),K,r)),n())}),V.paginas.addListener("venta",s),V.paginas.addListener("ventamax",s),V.paginas.addListener("visual",s),V.paginas.addListener("visual",(e,t)=>{function n(e){if(e.keyCode>=95&&e.keyCode<=105){let t=e.key;e.ctrlKey&&(l+=t,clearTimeout(i),i=setTimeout(()=>{$("#vnt-numeros").val(l),$("#md-montoVenta").modal(),l=""},2e3))}}function a(e){return e<10?`0${e}`:e.toString()}let r=$("#montoAnimal"),o=$("#md-montoVenta");o.on("shown.bs.modal",()=>{$("#md-montoInput").focus(),$("#md-montoInput").select()}),$(document).on("keydown",n);let i,l="";r.submit(function(e){e.preventDefault(e);let t=formControls(this);$("#vnt-monto").val(t.monto),$("#vnt-venta").trigger("submit"),o.modal("hide")});let s=$("#numpanel");for(let e=0;e<=36;e++)0==e&&s.append('<div class="numcell" numero="0"><img src="/assets/animales/0.jpg" class="numero"/><div class="overlay"></div></div>'),s.append(`<div class="numcell" numero="${a(e)}"><img src="/assets/animales/${a(e)}.jpg" class="numero"/><div class="overlay"></div></div>`);$(".numcell").click(function(e){let t=$(this).attr("numero");$("#vnt-numeros").val(t.toString()),$("#md-montoVenta").modal()})});var Z,Q,X=!1;V.paginas.addListener("sorteos/buscar",c),V.paginas.addListener("reporte/diario",d),V.paginas.addListener("reporte/general",m),V.paginas.addListener("reporte/sorteo",p),V.paginas.addListener("reporte/ventas",f),V.paginas.addListener("preferencias",u),V.paginas.addListener("ayuda",g),h();var Y=0;$("#logolink").click(function(){location.reload(!0)}),$("#vnt-anular").submit(function(e){e.preventDefault(e);var t=formControls(this),n=formLock(this);setTimeout(function(){formLock(n,!1)},2e3),b.sendMessage("venta-anular",t,function(e,a){formReset(n),a.hasOwnProperty("code")?2==a.code?notificacion("TICKET NO EXISTE"):4==a.code?notificacion("TICKET YA SE ENCUENTRA ANULADO"):5==a.code&&notificacion("TICKET INVALIDO","TICKET CADUCADO"):($("#md-anularTicket").modal("hide"),notificacion("TICKET ANULADO","TICKET #"+t.ticketID,"growl-success"))})}),$("#md-anularTicket").on("shown.bs.modal",function(e){var t=$("#md-anular-ticket");t.val(""),t.focus()});var W={formatDate:dateFormat,formatNumber:formatNumber,padding:padding};$("#vnt-pagar").submit(function(e){e.preventDefault(e);var t=formControls(this),n=formLock(this);b.sendMessage("venta-premios",t,function(e,t){formLock(n,!1),t.hasOwnProperty("code")?notificacion("TICKET NO EXISTE",""):(t.prm,$("#md-pagar-tpremio").html(jsrender($("#rd-premio-ticket"),[t.tk])),$("#md-pagar-prms").html(jsrender($("#rd-premio-premios"),t.prm,W)),$(".pagar-premio").click(function(e){var n=$(e.target),a=n.data("id"),r=n.data("ticket"),o=n.data("sorteoid"),i=findBy("ventaID",a,t.prm).premio,l=parseInt($("#md-pagar-codigo").val());n.prop("disabled",!0),b.sendMessage("venta-pagar",{id:a,tk:r,cod:l,sorteoID:o,premio:i},function(e,t){t.hasOwnProperty("code")?(notificacion("#"+r+": PAGO NO PROCESADO","CODIGO INVALIDO o TICKET EXPIRO","growl-danger"),n.prop("disabled",!1)):n.html('<i class="fa fa-check"></i>')})}),$("#anulado-timestamp").click(function(e){e.preventDefault(e);var t=$(this).attr("ticketID");b.sendMessage("ticket-anulado",{ticketID:t},function(e,t){t.hasOwnProperty("code")?notificacion("ERROR AL LEER HORA DE ANULACION"):$("#anulado-labelstamp").html('SI <i class="fa fa-clock-o"></i> '+t.tiempo)})}))})});var ee=$("#md-ticket");ee.on("shown.bs.modal",function(e){var t=$("#md-pagar-ticket");t.val(""),t.focus()}),ee.on("hidden.bs.modal",function(e){$("#md-pagar-ticket").val(""),$("#md-pagar-codigo").val("0"),$("#md-pagar-tpremio").html(""),$("#md-pagar-prms").html("")}),V.navUrl(),$(".logout").click(function(e){e.preventDefault(e),G=null,$(".username").html("Usuario"),localStorage.removeItem("loto_taqlogin"),V.nav("inicio")})};init();